# TES Property System — siaFINALwithbackend-database

A Node.js / Express REST API backend for the **TES Property System**, backed by a MySQL database (`TESdb`).  It handles authentication, property listings, user management, inquiries, calendar events, and activity logging.

---

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Runtime | Node.js |
| Framework | Express |
| Database | MySQL (`TESdb`) via `mysql2` |
| Auth | JSON Web Tokens (`jsonwebtoken`) + `bcryptjs` |
| File uploads | `multer` |
| Security | `helmet`, `express-rate-limit` |
| Dev tooling | `nodemon` |

---

## Getting Started

### 1. Clone & install

```bash
git clone https://github.com/HansLagmay/siaFINALwithbackend-database.git
cd siaFINALwithbackend-database
npm install
```

### 2. Configure environment

```bash
cp .env.example .env
```

Edit `.env` and set your MySQL credentials and a strong `JWT_SECRET`:

```
PORT=3000
CORS_ORIGIN=http://localhost:5173

DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_mysql_password
DB_NAME=TESdb

JWT_SECRET=change_this_to_a_long_random_secret
JWT_EXPIRES_IN=30d
```

### 3. Create the schema

```bash
npm run db:schema
```

### 4. Seed sample data

```bash
npm run db:seed
```

### 5. Start the server

```bash
# development (auto-reload)
npm run dev

# production
npm start
```

The API will be available at `http://localhost:3000/api`.

---

## Default Seeded Credentials

| Role  | Email                       | Password   |
|-------|-----------------------------|------------|
| Admin | admin@tesproperty.com       | admin123   |
| Agent | maria@tesproperty.com       | agent123   |
| Agent | juan@tesproperty.com        | agent123   |

---

## Uploads

Property images are stored in `server/uploads/properties/` and served statically:

```
GET /uploads/properties/<filename>
```

Upload new images (admin only):

```
POST /api/properties/upload   (multipart/form-data, field: images)
```

---

## Running with the SIAnewFINALfixed Frontend

In the frontend project's `.env` (or `.env.local`) set:

```
VITE_API_URL=http://localhost:3000/api
```

Then start both servers; the Vite dev server defaults to `http://localhost:5173`, which is already allowed by the backend CORS configuration.

---

## Repository Structure

```
siaFINALwithbackend-database/
├── .env.example            # Environment variable template
├── package.json            # Dependencies & npm scripts
├── scripts/
│   ├── createSchema.js     # Creates all MySQL tables (npm run db:schema)
│   └── seedDatabase.js     # Seeds users and sample data (npm run db:seed)
└── server/
    ├── index.js            # Express app entry point
    ├── db.js               # MySQL connection pool (mysql2)
    ├── middleware/
    │   ├── auth.js         # JWT authentication & role guards
    │   ├── rateLimiter.js  # express-rate-limit configs
    │   ├── sanitize.js     # Input sanitization
    │   ├── upload.js       # multer configuration
    │   └── logger.js       # Activity log helper
    ├── routes/
    │   ├── auth.js         # POST /api/login
    │   ├── users.js        # /api/users
    │   ├── properties.js   # /api/properties
    │   ├── inquiries.js    # /api/inquiries
    │   ├── calendar.js     # /api/calendar
    │   ├── activity-log.js # /api/activity-log
    │   └── database.js     # /api/database (admin utilities)
    └── uploads/
        └── properties/     # Uploaded property images
```

---

## API Overview

### Authentication
| Method | Endpoint    | Description              | Auth |
|--------|-------------|--------------------------|------|
| POST   | /api/login  | Login, returns JWT token | —    |

### Properties
| Method | Endpoint                    | Description                        | Auth          |
|--------|-----------------------------|------------------------------------|---------------|
| GET    | /api/properties             | List all properties (paginated)    | —             |
| GET    | /api/properties/:id         | Get single property                | —             |
| POST   | /api/properties             | Create property                    | Admin         |
| POST   | /api/properties/draft       | Create draft property              | Agent         |
| POST   | /api/properties/upload      | Upload property images             | Admin         |
| PUT    | /api/properties/:id         | Update property                    | Admin         |
| DELETE | /api/properties/:id         | Delete property                    | Admin         |

### Users
| Method | Endpoint         | Description        | Auth  |
|--------|------------------|--------------------|-------|
| GET    | /api/users       | List all users     | Admin |
| POST   | /api/users       | Create user        | Admin |
| PUT    | /api/users/:id   | Update user        | Admin |
| DELETE | /api/users/:id   | Delete user        | Admin |

### Inquiries
| Method | Endpoint             | Description          | Auth          |
|--------|----------------------|----------------------|---------------|
| GET    | /api/inquiries       | List inquiries       | Admin / Agent |
| POST   | /api/inquiries       | Submit inquiry       | —             |
| PUT    | /api/inquiries/:id   | Update inquiry       | Admin / Agent |
| DELETE | /api/inquiries/:id   | Delete inquiry       | Admin         |

### Calendar
| Method | Endpoint             | Description          | Auth          |
|--------|----------------------|----------------------|---------------|
| GET    | /api/calendar        | List events          | Admin / Agent |
| POST   | /api/calendar        | Create event         | Admin / Agent |
| PUT    | /api/calendar/:id    | Update event         | Admin / Agent |
| DELETE | /api/calendar/:id    | Delete event         | Admin / Agent |

### Activity Log
| Method | Endpoint            | Description       | Auth  |
|--------|---------------------|-------------------|-------|
| GET    | /api/activity-log   | View activity log | Admin |

### Health Check
| Method | Endpoint     | Description      | Auth |
|--------|--------------|------------------|------|
| GET    | /api/health  | Server heartbeat | —    |
